# -*- coding: utf-8 -*-
"""sistema-moderacao-ia

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rLNXzh2v1Gz8tG6oUhbn3sCP9KeTCnR9
"""

from google.colab import auth
auth.authenticate_user()

import os
import uuid
from google.colab import userdata
from google import genai
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.memory import MemorySaver
from typing import TypedDict, Optional
from IPython.display import Image, display

try:
    if "GOOGLE_API_KEY" not in os.environ:
        os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
        print("‚úÖ API Key configurada.")
except Exception as e:
    print("‚ö†Ô∏è Erro: Verifique se voc√™ criou o segredo 'GOOGLE_API_KEY' no Colab.")

client = genai.Client(api_key=os.environ["GOOGLE_API_KEY"])
MODELO = "gemini-2.5-flash"

class EstadoHibrido(TypedDict):
    texto: str
    status_moderacao: str
    motivo_bloqueio: Optional[str]
    analise_ia: Optional[str]
    revisao_ia: Optional[str]
    resultado_final: Optional[str]

def node_moderador(state: EstadoHibrido):
    """Filtro R√°pido (Python): Barra ofensas √≥bvias."""
    print(f"üõ°Ô∏è (Filtro): Verificando palavras proibidas...")
    texto_lower = state['texto'].lower()
    palavras_proibidas = ["idiota", "burro", "lixo", "golpe", "roubar", "fraude"]

    if any(p in texto_lower for p in palavras_proibidas):
        return {
            "status_moderacao": "Bloqueado",
            "motivo_bloqueio": "Linguagem ofensiva ou suspeita detectada."
        }
    return {"status_moderacao": "Aprovado"}

def node_analista(state: EstadoHibrido):
    """Agente de Risco: Focado em identificar anomalias financeiras."""
    print(f"ü§ñ (Analista de Risco): Auditando transa√ß√£o...")

    prompt = f"""
Atue como um Analista de Preven√ß√£o a Fraudes S√™nior de um banco corporativo.

Analise a solicita√ß√£o: "{state['texto']}"

DIRETRIZES DE SEGURAN√áA (RIGOROSAS):
1. "Fornecedor Novo" + Valor Alto (>10k) = ALTO RISCO (Suspeita de fraude ou desvio).
2. Linguagem vaga ou informal = ALERTA AMARELO.
3. Jamais elogie a transa√ß√£o. Seja frio e t√©cnico.

Sua sa√≠da deve listar os riscos identificados e recomendar: APROVAR, REJEITAR ou INVESTIGAR.
N√£o use formata√ß√£o markdown complexa, seja direto.
    """

    try:
        response = client.models.generate_content(model=MODELO, contents=prompt)
        texto_resp = response.text
        return {"analise_ia": texto_resp}
    except Exception as e:
        return {"analise_ia": f"Erro t√©cnico na IA: {str(e)}"}

def node_revisor(state: EstadoHibrido):
    """Agente de Compliance: Valida se a an√°lise de risco foi suficiente."""
    print("üßê (Compliance): Revisando parecer do analista...")

    prompt = f"""
Atue como Auditor de Compliance.
O Analista de Risco reportou: "{state['analise_ia']}"

Sua tarefa:
1. Se houver men√ß√£o a "Novo Fornecedor" e valores altos, voc√™ DEVE recomendar a reten√ß√£o para valida√ß√£o humana.
2. Seja extremamente conservador. O objetivo √© proteger o capital do banco.

Resuma seu parecer final em uma frase curta e s√©ria.
    """

    try:
        response = client.models.generate_content(model=MODELO, contents=prompt)
        texto_resp = response.text
        return {"revisao_ia": texto_resp}
    except Exception as e:
        return {"revisao_ia": "Erro na revis√£o."}

def node_executor(state: EstadoHibrido):
    """N√≥ Final: Simula a execu√ß√£o."""
    print("üöÄ (Core Banc√°rio): Processando transfer√™ncia...")
    return {"resultado_final": "‚úÖ Opera√ß√£o Conclu√≠da: Transfer√™ncia realizada com sucesso!"}

workflow = StateGraph(EstadoHibrido)

workflow.add_node("moderador", node_moderador)
workflow.add_node("analista", node_analista)
workflow.add_node("revisor", node_revisor)
workflow.add_node("executor", node_executor)

workflow.set_entry_point("moderador")

def roteador_moderacao(state: EstadoHibrido):
    if state["status_moderacao"] == "Bloqueado":
        return "fim_bloqueado"
    return "seguir_para_ia"

workflow.add_conditional_edges("moderador", roteador_moderacao, {"fim_bloqueado": END, "seguir_para_ia": "analista"})
workflow.add_edge("analista", "revisor")
workflow.add_edge("revisor", "executor")
workflow.add_edge("executor", END)

checkpointer = MemorySaver()
graph = workflow.compile(checkpointer=checkpointer, interrupt_before=["executor"])

display(Image(graph.get_graph().draw_mermaid_png()))

texto_input = "Gostaria de transferir 50 mil reais para fornecedor novo"

thread_id = str(uuid.uuid4())
config = {"configurable": {"thread_id": thread_id}}

print(f"--- üè¶ INICIANDO AUDITORIA DE TRANSA√á√ÉO (ID: {thread_id[:8]}) ---")

for event in graph.stream({"texto": texto_input}, config):
    pass

snapshot = graph.get_state(config)

if snapshot.values:
    estado_atual = snapshot.values

    if estado_atual.get("status_moderacao") == "Bloqueado":
        print(f"\n‚ùå BLOQUEIO AUTOM√ÅTICO: {estado_atual.get('motivo_bloqueio')}")

    elif estado_atual.get("revisao_ia"):
        print("\n" + "="*70)
        print(f"üõë PAUSA DE SEGURAN√áA: ALERTA DE COMPLIANCE")
        print(f"üí∞ Solicita√ß√£o: '{estado_atual['texto']}'")
        print("-" * 70)
        print(f"üìã Parecer T√©cnico (Analista): \n{estado_atual.get('analise_ia').strip()}")
        print("-" * 70)
        print(f"‚öñÔ∏è Parecer Final (Compliance): {estado_atual.get('revisao_ia').strip()}")
        print("="*70)

        print("\nPAINEL DE DECIS√ÉO DO GESTOR:")
        print(" [A] APROVAR (Assumir Risco)")
        print(" [R] REJEITAR (Seguir Compliance)")
        print(" [E] EDITAR/JUSTIFICAR (Inserir Override)")

        decisao = input("\n‚û°Ô∏è Decis√£o do Gestor: ").strip().lower()

        if decisao == "r":
            print("\nüö´ Transa√ß√£o REJEITADA pelo Gestor.")

        elif decisao == "e":
            print("\n‚úçÔ∏è MODO DE JUSTIFICATIVA (OVERRIDE)")
            print("Insira a justificativa para liberar ou alterar a transa√ß√£o.")
            nova_justificativa = input("   Justificativa: ")

            print("üíæ Registrando justificativa no log de auditoria...")

            graph.update_state(config, {"revisao_ia": f"[GESTOR LIBEROU]: {nova_justificativa}"})

            print("\n--- Processando Libera√ß√£o Manual ---")
            for event in graph.stream(None, config):
                if "resultado_final" in event.get("executor", {}):
                    print(f"\n{event['executor']['resultado_final']}")

        elif decisao == "a":
            print("\n--- Aprovado pelo Gestor. Executando... ---")

            for event in graph.stream(None, config):
                if "resultado_final" in event.get("executor", {}):
                    print(f"\n{event['executor']['resultado_final']}")

        else:
            print("\n‚ùå Comando inv√°lido. Opera√ß√£o cancelada.")